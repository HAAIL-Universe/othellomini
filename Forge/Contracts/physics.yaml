---
info:
  title: OthelloMini API
  version: 1.0.0
  description: |
    REST API for OthelloMini, an ethics-first AI chat companion with consent-gated 
    personalized assistance. All endpoints follow a consent-first architecture where 
    AI-generated suggestions pass through the Othello ethical gatekeeper before 
    presentation to the user.
    
    Core flows:
    - User sends chat message → AI responds + generates suggestions → Othello gates 
      suggestions by consent tier → user approves/denies
    - User adjusts consent tier → future suggestions filtered accordingly
    - Profile continuously updated from interactions
    
    Authentication: None (single-user MVP). All operations assume fixed user_id.

base_url: http://localhost:8000
api_version: v1

paths:
  /api/v1/chat:
    post:
      summary: Send a chat message and receive AI response with gated suggestions
      description: |
        Primary interaction endpoint. Accepts user message, updates user profile with 
        conversation context, generates AI response via OpenAI GPT-4, produces 
        potential action suggestions, gates them through Othello ethical filter, 
        and returns response with approved suggestions tagged by consent tier.
        
        Flow:
        1. Validate message input
        2. Retrieve current user profile (traits, consent tier, conversation history)
        3. Call OpenAI with system prompt + user context + message
        4. Extract action suggestions from AI response
        5. Pass suggestions through OthelloService.gate_suggestions()
        6. Filter by user's current consent tier
        7. Persist conversation and pending suggestions to DB
        8. Return response with inline suggestion cards
      auth: none
      request:
        content_type: application/json
        schema:
          type: object
          required:
            - message
          properties:
            message:
              type: string
              description: User's chat message text
              min_length: 1
              max_length: 4000
              example: "I've been feeling overwhelmed with work lately. Any advice?"
            context:
              type: object
              description: Optional additional context (mood, location, time of day)
              properties:
                mood:
                  type: string
                  enum: [calm, stressed, happy, sad, neutral]
                  example: stressed
                timestamp:
                  type: string
                  format: date-time
                  description: ISO 8601 timestamp (defaults to server time if omitted)
                  example: "2024-01-15T14:32:00Z"
      response:
        success:
          status: 200
          content_type: application/json
          schema:
            type: object
            required:
              - conversation_id
              - message
              - response
              - suggestions
              - profile_updated
            properties:
              conversation_id:
                type: string
                format: uuid
                description: Unique identifier for this conversation turn
                example: "c7f8a3e1-4b2d-4f9a-8c3e-1a2b3c4d5e6f"
              message:
                type: string
                description: Echo of user's message
                example: "I've been feeling overwhelmed with work lately. Any advice?"
              response:
                type: string
                description: AI-generated conversational response
                example: "It sounds like you're carrying a heavy load right now. Taking short breaks can help reset your focus. Would you like me to suggest a few specific strategies?"
              suggestions:
                type: array
                description: List of consent-gated action suggestions
                items:
                  $ref: '#/schemas/Suggestion'
              profile_updated:
                type: boolean
                description: Indicates if user profile was updated from this interaction
                example: true
              metadata:
                type: object
                description: Additional conversation metadata
                properties:
                  ai_model:
                    type: string
                    example: "gpt-4"
                  tokens_used:
                    type: integer
                    example: 342
                  processing_time_ms:
                    type: integer
                    example: 1820
        error:
          status: 400
          content_type: application/json
          schema:
            $ref: '#/schemas/Error'
          examples:
            - error_code: INVALID_MESSAGE
              message: "Message cannot be empty"
            - error_code: MESSAGE_TOO_LONG
              message: "Message exceeds 4000 character limit"
        server_error:
          status: 500
          content_type: application/json
          schema:
            $ref: '#/schemas/Error'
          examples:
            - error_code: OPENAI_API_ERROR
              message: "Failed to generate AI response"
            - error_code: DATABASE_ERROR
              message: "Failed to persist conversation"

  /api/v1/profile:
    get:
      summary: Retrieve current user profile summary
      description: |
        Returns the persistent user profile including psychological traits, 
        preferences, current consent tier, and recent conversation context. 
        Profile is continuously updated from chat interactions.
      auth: none
      response:
        success:
          status: 200
          content_type: application/json
          schema:
            $ref: '#/schemas/UserProfile'
        error:
          status: 404
          content_type: application/json
          schema:
            $ref: '#/schemas/Error'
          examples:
            - error_code: PROFILE_NOT_FOUND
              message: "User profile not initialized"

    patch:
      summary: Update user profile settings
      description: |
        Allows user to update consent tier and explicit preferences. Consent tier 
        determines which suggestions are surfaced:
        - Passive: observation only, no suggestions
        - Suggestive: low-risk suggestions (read articles, reflect on topic)
        - Active: medium-risk suggestions (schedule tasks, send drafts)
        - Autonomous: high-risk suggestions (execute actions, make commitments)
        
        Trait updates are NOT allowed via this endpoint (traits auto-learned from conversations).
      auth: none
      request:
        content_type: application/json
        schema:
          type: object
          properties:
            consent_tier:
              type: string
              enum: [passive, suggestive, active, autonomous]
              description: New consent tier level
              example: "suggestive"
            preferences:
              type: object
              description: Explicit user preferences (freeform key-value pairs)
              properties:
                communication_style:
                  type: string
                  enum: [direct, gentle, analytical, motivational]
                  example: "gentle"
                focus_areas:
                  type: array
                  items:
                    type: string
                  example: ["productivity", "mental_health", "relationships"]
                notification_frequency:
                  type: string
                  enum: [realtime, hourly, daily, weekly]
                  example: "daily"
      response:
        success:
          status: 200
          content_type: application/json
          schema:
            $ref: '#/schemas/UserProfile'
        error:
          status: 400
          content_type: application/json
          schema:
            $ref: '#/schemas/Error'
          examples:
            - error_code: INVALID_CONSENT_TIER
              message: "consent_tier must be one of: passive, suggestive, active, autonomous"

  /api/v1/profile/clear:
    post:
      summary: Clear all user profile data
      description: |
        Resets user profile to default state, deletes all conversation history 
        and suggestions. This is a destructive operation (no undo). Used for 
        privacy/reset scenarios.
      auth: none
      response:
        success:
          status: 200
          content_type: application/json
          schema:
            type: object
            required:
              - success
              - message
            properties:
              success:
                type: boolean
                example: true
              message:
                type: string
                example: "Profile cleared successfully"

  /api/v1/suggestions:
    get:
      summary: List all pending suggestions awaiting user action
      description: |
        Returns suggestions that have passed Othello gating and are awaiting 
        user approval/denial. Includes ethical reasoning and consent tier for 
        each suggestion.
      auth: none
      parameters:
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [pending, approved, denied, all]
            default: pending
          description: Filter by suggestion status
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Maximum number of suggestions to return
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Pagination offset
      response:
        success:
          status: 200
          content_type: application/json
          schema:
            type: object
            required:
              - suggestions
              - total
              - limit
              - offset
            properties:
              suggestions:
                type: array
                items:
                  $ref: '#/schemas/Suggestion'
              total:
                type: integer
                description: Total count of suggestions matching filter
                example: 7
              limit:
                type: integer
                example: 20
              offset:
                type: integer
                example: 0

  /api/v1/suggestions/{suggestion_id}/approve:
    post:
      summary: Approve a pending suggestion
      description: |
        Marks suggestion as approved. Updates user profile to reflect positive 
        signal (user accepts this type of suggestion). In full build, would 
        trigger action execution; in MVP, only updates status.
      auth: none
      parameters:
        - name: suggestion_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Unique suggestion identifier
      request:
        content_type: application/json
        schema:
          type: object
          properties:
            feedback:
              type: string
              description: Optional user feedback on why this was approved
              max_length: 500
              example: "This is exactly what I needed right now"
      response:
        success:
          status: 200
          content_type: application/json
          schema:
            type: object
            required:
              - suggestion_id
              - status
              - approved_at
            properties:
              suggestion_id:
                type: string
                format: uuid
                example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
              status:
                type: string
                enum: [approved]
                example: "approved"
              approved_at:
                type: string
                format: date-time
                example: "2024-01-15T14:45:30Z"
              message:
                type: string
                example: "Suggestion approved successfully"
        error:
          status: 404
          content_type: application/json
          schema:
            $ref: '#/schemas/Error'
          examples:
            - error_code: SUGGESTION_NOT_FOUND
              message: "Suggestion not found or already processed"

  /api/v1/suggestions/{suggestion_id}/deny:
    post:
      summary: Deny a pending suggestion
      description: |
        Marks suggestion as denied. Updates user profile to reflect negative 
        signal (user rejects this type of suggestion). Othello learns to avoid 
        similar suggestions in future.
      auth: none
      parameters:
        - name: suggestion_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Unique suggestion identifier
      request:
        content_type: application/json
        schema:
          type: object
          properties:
            reason:
              type: string
              description: Optional user reason for denial (helps train filter)
              max_length: 500
              example: "Too aggressive for my current state"
      response:
        success:
          status: 200
          content_type: application/json
          schema:
            type: object
            required:
              - suggestion_id
              - status
              - denied_at
            properties:
              suggestion_id:
                type: string
                format: uuid
                example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
              status:
                type: string
                enum: [denied]
                example: "denied"
              denied_at:
                type: string
                format: date-time
                example: "2024-01-15T14:47:12Z"
              message:
                type: string
                example: "Suggestion denied successfully"
        error:
          status: 404
          content_type: application/json
          schema:
            $ref: '#/schemas/Error'
          examples:
            - error_code: SUGGESTION_NOT_FOUND
              message: "Suggestion not found or already processed"

  /api/v1/conversations:
    get:
      summary: Retrieve conversation history
      description: |
        Returns paginated list of past conversations with timestamps. Used for 
        side panel history display and context reconstruction.
      auth: none
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Maximum number of conversations to return
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Pagination offset
        - name: since
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Only return conversations after this timestamp
      response:
        success:
          status: 200
          content_type: application/json
          schema:
            type: object
            required:
              - conversations
              - total
              - limit
              - offset
            properties:
              conversations:
                type: array
                items:
                  $ref: '#/schemas/Conversation'
              total:
                type: integer
                description: Total count of conversations
                example: 142
              limit:
                type: integer
                example: 50
              offset:
                type: integer
                example: 0

  /api/v1/health:
    get:
      summary: Health check endpoint
      description: |
        Returns API health status, database connectivity, and OpenAI API status. 
        Used for monitoring and Docker health checks.
      auth: none
      response:
        success:
          status: 200
          content_type: application/json
          schema:
            type: object
            required:
              - status
              - timestamp
              - services
            properties:
              status:
                type: string
                enum: [healthy, degraded, unhealthy]
                example: "healthy"
              timestamp:
                type: string
                format: date-time
                example: "2024-01-15T14:50:00Z"
              services:
                type: object
                properties:
                  database:
                    type: object
                    properties:
                      status:
                        type: string
                        enum: [up, down]
                        example: "up"
                      response_time_ms:
                        type: integer
                        example: 3
                  openai:
                    type: object
                    properties:
                      status:
                        type: string
                        enum: [up, down, unknown]
                        example: "up"
                      model:
                        type: string
                        example: "gpt-4"
              version:
                type: string
                example: "1.0.0"

schemas:
  UserProfile:
    type: object
    required:
      - user_id
      - consent_tier
      - traits
      - preferences
      - created_at
      - updated_at
    properties:
      user_id:
        type: string
        description: Fixed user identifier (single-user MVP)
        example: "default_user"
      consent_tier:
        type: string
        enum: [passive, suggestive, active, autonomous]
        description: Current consent level determining suggestion visibility
        example: "suggestive"
      traits:
        type: object
        description: Psychological traits learned from conversations (read-only)
        properties:
          openness:
            type: number
            format: float
            minimum: 0.0
            maximum: 1.0
            description: Openness to new experiences (Big Five trait)
            example: 0.72
          conscientiousness:
            type: number
            format: float
            minimum: 0.0
            maximum: 1.0
            example: 0.68
          extraversion:
            type: number
            format: float
            minimum: 0.0
            maximum: 1.0
            example: 0.45
          agreeableness:
            type: number
            format: float
            minimum: 0.0
            maximum: 1.0
            example: 0.81
          neuroticism:
            type: number
            format: float
            minimum: 0.0
            maximum: 1.0
            example: 0.53
          risk_tolerance:
            type: string
            enum: [low, medium, high]
            example: "medium"
          decision_style:
            type: string
            enum: [analytical, intuitive, collaborative, avoidant]
            example: "analytical"
      preferences:
        type: object
        description: User-defined preferences (editable via PATCH /profile)
        properties:
          communication_style:
            type: string
            enum: [direct, gentle, analytical, motivational]
            example: "gentle"
          focus_areas:
            type: array
            items:
              type: string
            example: ["productivity", "mental_health"]
          notification_frequency:
            type: string
            enum: [realtime, hourly, daily, weekly]
            example: "daily"
      context_summary:
        type: object
        description: Recent context extracted from last N conversations
        properties:
          recent_topics:
            type: array
            items:
              type: string
            description: Top 5 topics from recent conversations
            example: ["work_stress", "time_management", "exercise_goals"]
          mood_trend:
            type: string
            enum: [improving, stable, declining]
            example: "stable"
          last_interaction:
            type: string
            format: date-time
            example: "2024-01-15T14:32:00Z"
      created_at:
        type: string
        format: date-time
        description: Profile creation timestamp
        example: "2024-01-10T09:00:00Z"
      updated_at:
        type: string
        format: date-time
        description: Last profile update timestamp
        example: "2024-01-15T14:32:05Z"

  Suggestion:
    type: object
    required:
      - suggestion_id
      - text
      - consent_tier
      - ethical_reasoning
      - status
      - created_at
    properties:
      suggestion_id:
        type: string
        format: uuid
        description: Unique suggestion identifier
        example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
      text:
        type: string
        description: Human-readable suggestion text
        example: "Schedule a 15-minute break at 3pm to step outside and reset"
      action_type:
        type: string
        enum: [reflection, scheduling, communication, research, habit, goal]
        description: Category of suggested action
        example: "scheduling"
      consent_tier:
        type: string
        enum: [passive, suggestive, active, autonomous]
        description: Minimum consent tier required for this suggestion
        example: "suggestive"
      ethical_reasoning:
        type: object
        description: Othello's ethical validation details
        required:
          - passed
          - justification
        properties:
          passed:
            type: boolean
            description: Whether suggestion passed ethical gate
            example: true
          justification:
            type: string
            description: Human-readable explanation of ethical assessment
            example: "Low-risk self-care suggestion aligned with user's stated goal of reducing stress. No external commitments or data sharing involved."
          flags:
            type: array
            items:
              type: string
            description: Any ethical flags raised (even if suggestion passed)
            example: []
          confidence:
            type: number
            format: float
            minimum: 0.0
            maximum: 1.0
            description: Othello's confidence in ethical assessment
            example: 0.94
      risk_level:
        type: string
        enum: [low, medium, high]
        description: Estimated risk level of executing this suggestion
        example: "low"
      status:
        type: string
        enum: [pending, approved, denied, expired]
        description: Current suggestion status
        example: "pending"
      created_at:
        type: string
        format: date-time
        description: When suggestion was generated
        example: "2024-01-15T14:32:10Z"
      expires_at:
        type: string
        format: date-time
        description: When suggestion expires if not acted upon
        example: "2024-01-16T14:32:10Z"
      conversation_id:
        type: string
        format: uuid
        description: Associated conversation that generated this suggestion
        example: "c7f8a3e1-4b2d-4f9a-8c3e-1a2b3c4d5e6f"

  Conversation:
    type: object
    required:
      - conversation_id
      - user_message
      - ai_response
      - timestamp
    properties:
      conversation_id:
        type: string
        format: uuid
        description: Unique conversation identifier
        example: "c7f8a3e1-4b2d-4f9a-8c3e-1a2b3c4d5e6f"
      user_message:
        type: string
        description: User's input message
        example: "I've been feeling overwhelmed with work lately. Any advice?"
      ai_response:
        type: string
        description: AI's conversational response
        example: "It sounds like you're carrying a heavy load right now. Taking short breaks can help reset your focus."
      context:
        type: object
        description: Contextual metadata captured with conversation
        properties:
          mood:
            type: string
            example: "stressed"
          detected_topics:
            type: array
            items:
              type: string
            example: ["work_stress", "advice_seeking"]
      suggestions_count:
        type: integer
        description: Number of suggestions generated from this conversation
        example: 2
      timestamp:
        type: string
        format: date-time
        description: When conversation occurred
        example: "2024-01-15T14:32:00Z"

  Error:
    type: object
    required:
      - error_code
      - message
    properties:
      error_code:
        type: string
        description: Machine-readable error code
        example: "INVALID_MESSAGE"
      message:
        type: string
        description: Human-readable error message
        example: "Message cannot be empty"
      details:
        type: object
        description: Additional error context (optional)
        properties:
          field:
            type: string
            example: "message"
          constraint:
            type: string
            example: "min_length"
      timestamp:
        type: string
        format: date-time
        example: "2024-01-15T14:55:00Z"

error_codes:
  INVALID_MESSAGE:
    description: Message validation failed (empty, too long, invalid format)
    http_status: 400
  MESSAGE_TOO_LONG:
    description: Message exceeds 4000 character limit
    http_status: 400
  PROFILE_NOT_FOUND:
    description: User profile not initialized
    http_status: 404
  SUGGESTION_NOT_FOUND:
    description: Suggestion ID not found or already processed
    http_status: 404
  INVALID_CONSENT_TIER:
    description: Invalid consent tier value provided
    http_status: 400
  OPENAI_API_ERROR:
    description: OpenAI API request failed
    http_status: 500
  DATABASE_ERROR:
    description: Database operation failed
    http_status: 500
  RATE_LIMIT_EXCEEDED:
    description: Too many requests from user (future implementation)
    http_status: 429

rate_limits:
  /api/v1/chat:
    limit: 60
    window: 60s
    description: Maximum 60 chat messages per minute per user
  /api/v1/suggestions/{suggestion_id}/approve:
    limit: 100
    window: 60s
    description: Maximum 100 approvals per minute
  /api/v1/suggestions/{suggestion_id}/deny:
    limit: 100
    window: 60s
    description: Maximum 100 denials per minute

notes:
  - All timestamps use ISO 8601 format with UTC timezone
  - UUIDs are version 4 (random) unless otherwise specified
  - Consent tier hierarchy: passive < suggestive < active < autonomous
  - Suggestions are auto-expired after 24 hours if not acted upon
  - Profile traits are mock values in MVP (static seed data), full build uses LLM extraction
  - Ethical reasoning is rule-based in MVP, full build uses LLM-based ethical analysis
  - Single-user assumption means no authentication/authorization in MVP
  - All numeric trait scores use 0.0-1.0 scale (0.0 = low trait expression, 1.0 = high)
